<%- include('../partials/header') %>

<div class="container-scroller">
    <%- include('../partials/user-header', { isAuthenticated: isAuthenticated }) %>
    <!-- partial -->
    <div class="container-fluid page-body-wrapper ps-0 pe-0">
        <!-- partial:partials/_sidebar.html -->
        <nav class="sidebar sidebar-offcanvas border" id="sidebar">
            <ul class="nav">
                <li class="nav-item">
                    <a class="nav-link" href="/account/profile">
                        <span class="menu-title">Profile</span>
                        <i class="mdi mdi-home menu-icon"></i>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/account/wishlist">
                        <span class="menu-title">Wishlist</span>
                        <i class="mdi mdi-heart menu-icon"></i>
                    </a>
                </li>
                <li class="nav-item active bg-gradient-info">
                    <a class="nav-link">
                        <span class="menu-title font-weight-bold text-white">Orders</span>
                        <i class="mdi mdi-format-list-bulleted menu-icon"></i>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/account/address">
                        <span class="menu-title">Address</span>
                        <i class="mdi mdi-google-maps menu-icon"></i>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/account/wallet">
                        <span class="menu-title">Wallet</span>
                        <i class="mdi mdi-wallet menu-icon"></i>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/account/coupons">
                        <span class="menu-title">Coupons</span>
                        <i class="mdi mdi-ticket menu-icon"></i>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/logout">
                        <span class="menu-title">Logout</span>
                        <i class="mdi mdi-logout menu-icon"></i>
                    </a>
                </li>
            </ul>
        </nav>
        <div class="main-panel mt-5 pt-2 w-100">
            <!-- Breadcrumb Section Begin -->
    <section class="breadcrumb-option mt-3" style="background-color: rgb(232, 243, 250);">
        <div class="container-fluid">
            <div class="row">
                <div class="col-lg-12">
                    <div class="breadcrumb__text ps-4">
                        <h4>Orders</h4>
                        <div>
                            <a class="text-decoration-none text-dark fw-bold" href="/">Home&nbsp;&gt;&nbsp;</a>
                            <a class="text-decoration-none text-dark fw-bold" href="/account/profile">Account</a>
                            <span>&nbsp;&gt;&nbsp;Orders</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
    <!-- Breadcrumb Section End -->
            <div class="content-wrapper row" style="background-color: white;">
                <section class="shopping-cart spad">
                    <div class="container">
                        <div class="row">
                            <div class="col-lg-12">
                                <div class="table-responsive">
                                    <table class="w-100 text-center">
                                        <thead>
                                            <tr class="border-bottom">
                                                <th class="pe-4 p-3">Order ID</th>
                                                <th class="pe-4">Order Date</th>
                                                <th class="pe-4">Total Price</th>
                                                <th class="pe-4">Items Count</th>
                                                <th class="pe-4">Status</th>
                                                <th class="pe-4">paymentStatus</th>
                                                <th class="pe-4">Details</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <% orders.forEach(order => { %>
                                                <% let itemsCount = order.items.length; %>
                                                <% let totalPrice = 0; %>
                                                <% order.items.forEach(item => { %>
                                                    <% if (item.orderStatus !== 'Canceled') { %>
                                                        <% totalPrice += item.productDiscPrice * item.quantity; %>
                                                    <% } %>
                                                <% }); %>
                                                <tr class="border-bottom">
                                                    <td class="pe-4 p-4"><%= order.orderID %></td>
                                                    <td class="pe-4"><%= order.orderDate.toLocaleDateString() %></td>
                                                    <td class="cart__price pe-4">&#8377;<%= totalPrice.toFixed(2) %></td>
                                                    <td class="pe-4"><%= itemsCount %></td>
                                                    <td class="pe-4 pt-3">
                                                        <% let allDelivered = true; %>
                                                        <% let allCancelled = true; %>
                                                        <% order.items.forEach(item => { %>
                                                            <% if (item.orderStatus !== 'Delivered') { %>
                                                                <% allDelivered = false; %>
                                                            <% } %>
                                                            <% if (item.orderStatus !== 'Canceled') { %>
                                                                <% allCancelled = false; %>
                                                            <% } %>
                                                        <% }); %>
                                                        <% if (allDelivered) { %>
                                                            <p class="text-success">Delivered</p>
                                                        <% } else if (allCancelled) { %>
                                                            <p class="text-warning">Canceled</p>
                                                        <% } else { %>
                                                            <p>Pending</p>
                                                        <% } %>
                                                    </td>
                                                    <td class="pe-4">
                                                        <% if (order.items.every(item => item.orderStatus === 'Canceled')) { %>
                                                            <p>All items canceled</p>
                                                        <% } else if (order.items.every(item => item.orderStatus === 'Delivered')) { %>
                                                            <p>All items Delivered</p>
                                                        <% } else if (order.paymentStatus === 'Pending' && order.items.some(item => ['Pending', 'Processing', 'Dispatched'].includes(item.orderStatus))) { %>
                                                            <button class="btn btn-outline-secondary pay-now-btn" data-order-id="<%= order._id %>">Pay Now</button>
                                                        <% } else { %>
                                                            <p>Paid</p>
                                                        <% } %>
                                                    </td>                                                                                                    
                                                    <td class="pe-4">
                                                        <a href="/account/orders/order_details?id=<%= order._id %>" class="btn btn-outline-primary">Info</a>
                                                    </td>
                                                </tr>
                                            <% }); %>
                                            <% if (orders.length === 0) { %>
                                                <tr class="text-center">
                                                    <td colspan="6">No orders found!</td>
                                                </tr>
                                            <% } %>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        <div class="row p-3">
                            <div class="pagination d-flex justify-content-center align-items-center">
                                <% if (currentPage > 1) { %>
                                    <a href="?page=<%= currentPage - 1 %>&limit=<%= limit %>" class="btn btn-outline-info">&lt;</a>
                                <% } %>
                                <% for (let i = Math.max(1, currentPage - 1); i <= Math.min(currentPage + 1, totalPages); i++) { %>
                                    <a href="?page=<%= i %>&limit=<%= limit %>" class="btn btn-outline-secondary <%= currentPage === i ? 'active' : '' %>">
                                        <%= i %>
                                    </a>
                                <% } %>
                                <% if (currentPage < totalPages) { %>
                                    <a href="?page=<%= currentPage + 1 %>&limit=<%= limit %>" class="btn btn-outline-info">&gt;</a>
                                <% } %>
                            </div>
                        </div>
                    </div>                    
                </section>  
            </div>
            <!-- content-wrapper ends -->
            <!-- partial:partials/_footer.html -->
            <!-- partial -->
        </div>
        
    <!-- page-body-wrapper ends -->
</div>
<!-- container-scroller --> 
<style>
    header {
        position: relative;
        position: fixed;
        width: 100vw;
        z-index: 999;
    }
    .sidebar{
        position: relative;
        position: absolute;
        position: fixed;
        z-index: 999;
        top:70px;
    }
    @media ( min-width : 992px){
        .main-panel {
            margin-left: 250px;
            width: 100%;
        }
        .sidebar {
            margin-top: 12.3px;
        }
    }
</style>
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('.pay-now-btn').forEach(button => {
            button.addEventListener('click', async function() {
                const orderId = this.getAttribute('data-order-id');
                
                try {
                    const response = await fetch('/continue_payment', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ orderId })
                    });
                    const data = await response.json();

                    if (response.ok) {
                        const options = {
                            key: data.key,
                            amount: data.amount,
                            currency: data.currency,
                            order_id: data.razorpayOrderId,
                            handler: async function (response) {
                                const paymentData = {
                                    orderCreationId: data.razorpayOrderId,
                                    razorpayPaymentId: response.razorpay_payment_id,
                                    razorpayOrderId: response.razorpay_order_id,
                                    razorpaySignature: response.razorpay_signature
                                };
                                const verifyResponse = await fetch('/verify_continue_payment', {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json'
                                    },
                                    body: JSON.stringify(paymentData)
                                });
                                const verifyData = await verifyResponse.json();
                                if (verifyResponse.ok) {
                                    Swal.fire({
                                        icon: 'success',
                                        title: 'Payment Successful',
                                        text: 'Your order has been placed successfully.',
                                    }).then(() => {
                                        window.location.reload();
                                    });
                                } else {
                                    Swal.fire({
                                        icon: 'error',
                                        title: 'Payment Verification Failed',
                                        text: verifyData.error,
                                    });
                                }
                            },
                            prefill: {
                                name: 'Customer Name',
                                email: 'customer@example.com',
                                contact: '9999999999'
                            },
                            theme: {
                                color: '#3399cc'
                            }
                        };
                        const rzp1 = new Razorpay(options);
                        rzp1.on('payment.failed', function (response) {
                            Swal.fire({
                                icon: 'error',
                                title: 'Payment Failed',
                                text: 'Your payment could not be processed. Please try again.',
                            });
                        });
                        rzp1.open();
                    } else {
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: data.error,
                        });
                    }
                } catch (error) {
                    console.error('Error:', error);
                    Swal.fire({
                        icon: 'error',
                        title: 'Unexpected Error',
                        text: 'An unexpected error occurred. Please try again later.',
                    });
                }
            });
        });
    });
</script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
<script>
    $(document).ready(function () {
        $('[data-toggle="offcanvas"]').click(function () {
            $('.sidebar-offcanvas').toggleClass('active');
        });
    });
</script>

<!-- plugins:js -->
<script src="assets/vendors/js/vendor.bundle.base.js"></script>
<!-- endinject -->
<!-- Plugin js for this page -->
<script src="assets/vendors/chart.js/Chart.min.js"></script>
<script src="assets/js/jquery.cookie.js" type="text/javascript"></script>
<!-- End plugin js for this page -->
<!-- inject:js -->
<script src="assets/js/off-canvas.js"></script>
<script src="assets/js/hoverable-collapse.js"></script>
<script src="assets/js/misc.js"></script>
<!-- endinject -->
<!-- Custom js for this page -->
<script src="assets/js/dashboard.js"></script>
<script src="assets/js/todolist.js"></script>
<!-- End custom js for this page -->


<%- include('../partials/footer') %>